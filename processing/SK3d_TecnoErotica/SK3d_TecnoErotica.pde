/*                                                                                                                                                                                                                                                                                                
 
 .:::::::`         .-:////:-`      .:::::::::::::::::::`      .--:::::::.    -::::::::::--.`             `-:////::.`               `.-:////:-.`        `:::::::::::::::::::.  .::::::-``::::::::-    .:::::::-`     `.::////:-`             `.:////:        `::::::-`         -::::::::::::::::.      
 /yyyyyyy-      `/syyyyyyyyyyo-    :yyyyyyyyyyyyyyyyyyy.   .+syyyyyyyyyy/    oyyyyyyyyyyyyyys/.       `:oyyyyyyyyyyy+.          ./oyyyyyyyyyyyyo:`     .yyyyyyyyyyyyyyyyyyy:  +yyyyyyy. +yyyyyyyy`  `oyyyyyyy+    -oyyyyyyyyyyyo-         ./syyyyyyy`       .yyyyyyy.         syyyyyyyyyyyyyyyy-      
 /yyyyyyy-     :syyyyyyyyyyyyyy+`  :yyyyyyyyyyyyyyyyyyy.  :yyyyyyyyyyyyy/    oyyyyyyyyyyyyyyyyy/     .syyyyyyyyyyyyyyy-       -oyyyyyyyyyyyyyyyyyy+`   .yyyyyyyyyyyyyyyyyyy:  +yyyyyyy. `syyyyyyy+  /yyyyyyyo`  `oyyyyyyyyyyyyyyy/       :yyyyyyyyyy`       .yyyyyyy.         syyyyyyyyyyyyyyyo       
 /yyyyyyy-    -yyyyyyyyyyyyyyyyy/  :yyyyyyyyyyyyyyyyyyy. .yyyyyyyyyyyyyy/    oyyyyyyyyyyyyyyyyyy/   `syyyyyyyyyyyyyyyys`    `+yyyyyyyyyyyyyyyyyyyyys-  .yyyyyyyyyyyyyyyyyyy:  +yyyyyyy.  .yyyyyyyy..yyyyyyys`   oyyyyyyyyyyyyyyyyy-     :yyyyyyyyyyy`       .yyyyyyy.         syyyyyyyyyyyyyyy.       
 /yyyyyyy-    oyyyyyyy+:/yyyyyyys  .:::::oyyyyyyy/:::::` -yyyyyyys/:::::.    oyyyyyyy-.-/yyyyyyyy`  :yyyyyyyo/:syyyyyyy-   `oyyyyyyyys+/::/oyyyyyyyyy- `:::::/yyyyyyyo:::::.  +yyyyyyy.   -yyyyyyyooyyyyyyy-   .yyyyyyys/:+yyyyyyy/     syyyyyyyy+::        .yyyyyyy.         :::::::/yyyyyyy/        
 /yyyyyyy-    syyyyyys`  oyyyyyyy        :yyyyyyy.       -yyyyyyyo.`````     oyyyyyyy`  `oyyyyyyy`  +yyyyyyy.  -yyyyyyy:   /yyyyyyys-`      .oyyyyyyys`      .yyyyyyy/        +yyyyyyy.    /yyyyyyyyyyyyyy:    -yyyyyyy:  `yyyyyyy+     syyyyyyyo           .yyyyyyy.                /yyyyyyy`        
 /yyyyyyy-    syyyyyys   +yyyyyyy`       :yyyyyyy.       -yyyyyyyyysssss`    oyyyyyyy`/+syyyyyyy+   +yyyyyyy`  -yyyyyyy:   syyyyyyy.         `:::---..       .yyyyyyy/        +yyyyyyy.     +yyyyyyyyyyyy+     -yyyyyyy-  `yyyyyyy+     +yyyyyyyy-          .yyyyyyy.               .yyyyyyy:         
 /yyyyyyy-    syyyyyys   +yyyyyyy`       :yyyyyyy.       -yyyyyyyyyyyyyy`    oyyyyyyy`oyyyyyyyy+`   +yyyyyyyo+.-yyyyyyy:   yyyyyyys           -:::::--`      .yyyyyyy/        +yyyyyyy.     `syyyyyyyyyyo`     -yyyyyyyo+:`yyyyyyy+     `syyyyyyyy-         .yyyyyyy.               +yyyyyys`         
 /yyyyyyy-    syyyyyys   +yyyyyyy`       :yyyyyyy.       -yyyyyyyyssssss`    oyyyyyyy`oyyyyyys-     +yyyyyyyyy--yyyyyyy:   syyyyyyy.         .yyyyyyyy`      .yyyyyyy/        +yyyyyyy.      .yyyyyyyyys.      -yyyyyyyyy+`yyyyyyy+      `syyyyyyyy`        .yyyyyyy.              -yyyyyyy-          
 /yyyyyyy-    syyyyyys`  +yyyyyyy`       :yyyyyyy.       -yyyyyyy:``````     oyyyyyyy`oyyyyyyy:     +yyyyyyyyy:-yyyyyyy:   /yyyyyyys-`      .syyyyyyy+       .yyyyyyy/        +yyyyyyy.       :yyyyyyyy-       -yyyyyyyyy+`yyyyyyy+       :yyyyyyyy:        .yyyyyyy.             `syyyyyyo           
 :sssssss.    syyyysso///oossyyyy` .:::::+sssssss/:::::` -yyyysss+/:::::-    +sssssss/+sssssyyy.    +yyyyssooo++osssyyy:   `oyyyyyyss+//////ossyyyyys` `:::::/sssssss+:::::.  /sssssss.`::::::/osyyyyso/::::::`-yyyysssooo/oossyyy+   -/:/syssooooo+`       .sssssso.         ::::/sssssss+::::-      
 -ooooooo.    sysooooooooooooosyy` -ooooooooooooooooooo. `ssoooooooooooo/    /ooooooooooooooooss`   +ysoooooooooooooosy:    `+yysoooooooooooooooosyo.  `ooooooooooooooooooo-  :ooooooo. -oooooooosyyyoooooooo- -yyoooooooooooooosy+   /yyysooooooooo`       .ooooooo`         +ooooooooooooooo+`      
 -ooooooo.    ooooooooooooooooooy` -ooooooooooooooooooo.  /ooooooooooooo/    /oooooooooooooooooo+`  +sooooooooooooooooo:     `+oooooooooooooooooooo-   `ooooooooooooooooooo-  :ooooooo.  /ooooooooyyoooooooo:  -sooooooooooooooooo+   /yyooooooooooo`       .ooooooo`         +ooooooooooooooo:       
 -ooooooo.    +oooooooooooooooooo` -+++++ooooooooo+++++` .oooooooooooooo:    /ooooooo+++ooooooooo/  /oooooooooooooooooo-    `/oooooooooooooooooooooo:  `+++++ooooooooo+++++-  :ooooooo.  `+ooooooossooooooo/   -oooooooooooooooooo/   :yooooooooooo+`       .ooooooo`         ++ooooooooooooo+`       
 -ooooooo.    +ooooooo-..+ooooooo  `.....:ooooooo-.....  -ooooooo+......`    /ooooooo```.+ooooooo-  :ooooooo:../ooooooo-   `+ooooooo+:-:::::+oooooooo-  .....-ooooooo:.....`  :ooooooo`   `+oooooooooooooo+`   .ooooooo/..-ooooooo/   `-oooooooo+-.`        .ooooooo`         `......-ooooooo-        
 -ooooooo.    +oooooo+   /ooooooo        -ooooooo.       -ooooooo+-.....     /oooooo+` ``+oooooo+`  :ooooooo`  .ooooooo-   :ooooooo/`       `:++++++++`      .ooooooo:        :ooooooo`    .ooooooooooooo+.    -ooooooo-  `ooooooo/     +ooooooo/           .ooooooo`                :oooooo+         
 -ooooooo.    +oooooo+   /ooooooo        -ooooooo.       -oooooooooooooo`    /oooooo+`:+oooooooo-   :ooooooo`` .ooooooo-   +oooooo+`          ..`````        .ooooooo:        :ooooooo`     :oooooooooooo-     -ooooooo-` `ooooooo/     -oooooooo-          .ooooooo`               .ooooooo.         
 -ooooooo.    +oooooo+   /ooooooo        -ooooooo.       -oooooooooooooo`    /oooooo+`/ooooooo+-    :ooooooo++..ooooooo-   ooooooo+           :///::::`      .ooooooo:        :ooooooo`      /oooooooooo:      -ooooooo++:`ooooooo/      /oooooooo-         .ooooooo`               +oooooo/          
 -ooooooo.    +oooooo+   /ooooooo        -ooooooo.       -ooooooo+//////`    /oooooo+`/oooooo+`     :ooooooooo-.ooooooo-   +ooooooo-         .ooooooo+       .ooooooo:        :ooooooo`      `+oooooooo/       -ooooooooo:`ooooooo/       /oooooooo`        .ooooooo`              -ooooooo.          
 -ooooooo.    +oooooo+   /ooooooo        -ooooooo.       -ooooooo.           /oooooo+`/ooooooo:     :ooooooooo-.ooooooo-   -oooooooo:`     `-oooooooo-       .ooooooo:        :ooooooo`       .+oooooo+`       -ooooooooo:`ooooooo/       -oooooooo-        .ooooooo`             `+oooooo:           
 :sssssss.    +ooooooo-::osoooooo  `...../sssssss-.....  .oooooooooooooo:    +sssssso..oooooooo-    :oooooosss+/ssooooo-    :oooooooooo+++oooooooooo/   .....-sssssss/.....`  /sssssso.`.......:oooooo:....... -oooooossso:ssooooo/   -///oooosssss/        .sssssso`         `.../sssssso-....`      
 +mmmmmmm:    +ooshddmmmmmmddyooo  /mmmmmmmmmmmmmmmmmmm-  /oyhdddmmmmmmmo    ymmmmmmmmmmdddhhsoo.   :oosyddmmmmmmmdhyoo-     -+oosyhddmmmmmmddhysoo:   .mmmmmmmmmmmmmmmmmmm/  ommmmmmd.`ymmmmmmmdoooohmmmmmmmy`-oooyhdmmmmmmmddyoo/   :ooooshdmmmmmd`       -mmmmmmd.         hmmmmmmmmmmmmmmmd/      
 +mmmmmmm:    +shmmmmmmmmmmmmmdyo  /mmmmmmmmmmmmmmmmmmm-  -dmmmmmmmmmmmmo    ymmmmmmmmmmmmmmmmds+`  :ohdmmmmmmmmmmmmmds-      .ydmmmmmmmmmmmmmmmmd+    .mmmmmmmmmmmmmmmmmmm/  ommmmmmd. .dmmmmmmmyoosmmmmmmmh. -oydmmmmmmmmmmmmmds/   :oosdmmmmmmmmd`       -mmmmmmd.         hmmmmmmmmmmmmmmmy       
 +mmmmmmm:    +dmmmmmmmmmmmmmmmds  /mmmmmmmmmmmmmmmmmmm- `hmmmmmmmmmmmmmo    ymmmmmmmmmmmmmmmmmds/  :dmmmmmmmmmmmmmmmmd-     /dmmmmmmmmmmmmmmmmmmmmy.  .mmmmmmmmmmmmmmmmmmm/  ommmmmmd.  :dmmmmmmdo+dmmmmmmd-  .hmmmmmmmmmmmmmmmmd/   -osdmmmmmmmmmd`       -mmmmmmd.         hmmmmmmmmmmmmmmd-       
 +mmmmmmm-    smmmmmmmhsydmmmmmmh  :ssssshmmmmmmmysssss. :mmmmmmmdysssss/    ymmmmmmd+++sdmmmmmmh`  /mmmmmmmdssdmmmmmmd:    odmmmmmmmdhsssydmmmmmmmmh. .sssssymmmmmmmhsssss:  ommmmmmd.   +dmmmmmmysmmmmmmd/   .dmmmmmmdsshmmmmmmm+    `hmmmmmmmmhso`       -mmmmmmd.         osssssssdmmmmmms        
 +mmmmmmm-    ymmmmmmh`  ymmmmmmm`       +mmmmmmm-       :mmmmmmmy           ymmmmmmd`   ymmmmmmd.  ommmmmmm-  /mmmmmmm/   /dmmmmmmd+.     `/dmmmmmmmy       -mmmmmmm+        ommmmmmd.    smmmmmmddmmmmmmo    :mmmmmmm+  .mmmmmmms    `hmmmmmmmy`          -mmmmmmd.                :dmmmmmd.        
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-       :mmmmmmmdhyyyyy`    ymmmmmmd`:/odmmmmmmy   ommmmmmm`  :mmmmmmm/   hmmmmmmd:         -oooo++//`      -mmmmmmm+        ommmmmmd.    `ymmmmmmmmmmmmy`    :mmmmmmm:  `mmmmmmms     smmmmmmmh.          -mmmmmmd.               `hmmmmmmo         
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-       :mmmmmmmmmmmmmm`    ymmmmmmd`ymmmmmmmmy.   ommmmmmm+/.:mmmmmmm/   dmmmmmmh`          .---....`      -mmmmmmm+        ommmmmmd.     .dmmmmmmmmmmh.     :mmmmmmms/-`mmmmmmms     .dmmmmmmmh.         -mmmmmmd.               ommmmmmh`         
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-       :mmmmmmmmmmmmmm`    ymmmmmmd`ymmmmmmd/`    ommmmmmmmm::mmmmmmm/   dmmmmmmd.         `hddddddd.      -mmmmmmm+        ommmmmmd.      :dmmmmmmmmd-      :mmmmmmmmmo`mmmmmmms      -dmmmmmmmh`        -mmmmmmd.              .dmmmmmm/          
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-       :mmmmmmd+------     ymmmmmmd`ymmmmmmd-     ommmmmmmmm::mmmmmmm/   smmmmmmmy.       `sdmmmmmmy       -mmmmmmm+        ommmmmmd.       +dmmmmmmd/       :mmmmmmmmmo`mmmmmmms       /mmmmmmmm:        -mmmmmmd.              ymmmmmmh`          
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-       :mmmmmmdo//////-    ymmmmmmd`:dmmmmmmh.    ommmmmmmmm::mmmmmmm/   .hmmmmmmmds/---:ohmmmmmmmd.       -mmmmmmm+        ommmmmmd.       `smmmmmmo        :mmmmmmmmmo`mmmmmmms   -:-:ymmmmmmmm/        -mmmmmmd.             /dmmmmmm:           
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-       .dmmmmmmmmmmmmmo    ymmmmmmd` +dmmmmmmy`   ommmmmmm-.`:mmmmmmm/    -ymmmmmmmmdddddmmmmmmmmh-        -mmmmmmm+        ommmmmmd.        `hmmmmy`        :mmmmmmm/.``mmmmmmms   +dddmmmmmmmmd.        -mmmmmmd.            `hmmmmmmy            
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-        /dmmmmmmmmmmmmo    ymmmmmmd`  odmmmmmmo   ommmmmmm`  :mmmmmmm/     `+hmmmmmmmmmmmmmmmmmds.         -mmmmmmm+        ommmmmmd.         -dmmh.         :mmmmmmm:  `mmmmmmms   +mmmmmmmmmmh:         -mmmmmmd.            ommmmmmd-            
 +mmmmmmm-    hmmmmmmh   smmmmmmm`       /mmmmmmm-         .oydmmmmmmmmmo    ymmmmmmd`  `smmmmmmd/  ommmmmmm`  :mmmmmmm/       ./ydmmmmmmmmmmmdho-           -mmmmmmm+        ommmmmmd.          /dd-          :mmmmmmm:  `mmmmmmms   +mmmmmmmdh+.          -mmmmmmd.           -dmmmmmmo             
 .///////`    ://////:   -///////        .///////`           `.-:://////-    ://////:    `///////:  -///////`  .///////.         `.:/ossyyso+:.`             `///////.        -///////`           +/           .///////.   ///////-   .+ssyso/-`            `///////`           -///////`             
 ``                                             ./oo+-                     `                                              ./oo+-                     `                                              ./oo+.                   `                                              ./oo+.           
 :ydhs-                                         -smNNMMm.                  /hdho-                                         :ymNNMMd`                  +hdho.                                        `:ymNMMMh`                +hdho.                                        `:ymNMMMh`          
 .mMMMMNy:`                                    -smNNNNmmM-                 -NMMMMms:`                                    -yNNNNNmmN.                 :MMMMMms-`                                    :yNNNNNmNN`               :MMMMMms-`                                    :yNNNNNmNN`          
 -MMNNNMMNd+.                                .+mNNNNNmhhN.                 /MMNNMMMNh/`                                .omNNNNNmhdm`                 +MMNNMMMNh:`                                -sNNNNNNdhdd`               +MMNNMMMNh:`                                -sNNNNNNdhdd`          
 -NNmmNNNNNNdo-`                           .omNNNNNmdyssm`                 :MNmmNNNNNNdo-`                           -smNNNNNmdysyd                  +MmmmNNNNNNd+-`                          `-yNNNNNNmdysyy                +MmmmNNNNNNd+-`                          `-yNNNNNNmdysyy           
 `hmyydmNNNNNNNh+`    ```.               `/dNNNmmmmdhs+oh                  `ddyhdmNNNNNNNh/`    ```.               `+mNNNmmmmdho+ss                  `NdyhdmNNNNNNNy:`    ```.               `omNNNmmmmdyo+yo                `NdyhdmNNNNNNNy:`    ```.               `omNNNmmmmdyo+yo           
 +moodmmmNNNNNNms--++o//+.         `` `.+ydNNmmmdy+///o:                   om+smNmmNNNNNNmo.:++o//o`         `` `.+hdNNmmddy+///s-                   yd+ymNmmNNNNNNmo.:++o:/+`         `` `.ohmNNmmdhs+///s.                 yd+ymNmmNNNNNNmo.:++o:/+`         `` `.ohmNNmmdhs+///s.           
 `ho+ydmmmmNNmdhyhyys+:+++/```./-.-+++sshdmddddhso/:-:+`                   .h++ymmmmmNNmdhhhyyo+:+o+/```-/-`-+++ssdmmddhdhso/:-:+                    -h+ohmmmmmNNmdhhhyyo+:+o+:```-/-`:+++ssdmmddhdhs+/--:+                  -h+ohmmmmmNNmdhhhyyo+:+o+:```-/-`:+++ssdmmddhdhs+/--:+            
 .s+oyhddddhdmmddhhs+:oo+o++ooosso/+syyhyhmddsys+/:::-                     .s+oyhddddhdmmdhhyo+:oo+o++ooosoo/+shyhhhmddsys+/::/.                     :o+oyhddddhdmmdhhyo+:oo+o++oooso+/+syyhhdmdhsyo+/::/.                   :o+oyhddddhdmmdhhyo+:oo+o++oooso+/+syyhhdmdhsyo+/::/.            
 -s/syys+oyhddhhyso+::/sssssssyoo//oyyhyyyddhysoshh.                       :s/syyo+syhhdhhyso/::/sosssosyoo:/oyyhyyyddhysoshh.                       /o/syyo+sydhdhhys+/::+sosssoyso+:/syyhyyhddhysoyhy`                     /o/syyo+sydhdhhys+/::+sosssoyso+:/syyhyyhddhysoyhy`             
 +yhhyoyhyyhhsysyys+ossysyyshosoosyhyyshyhhhdhysyy-                       `oydhsoyhyyhhsysyys+ossysyysyosooyhhyyshyhhhdhssyy-                       `shdhssyhyhhhsysyys+ossysyyyyosooyhhyyyhyhhhdhssyy.                     `shdhssyhyhhhsysyys+ossysyyyyosooyhhyyyhyhhhdhssyy.             
 /syyhhdddddhyssysysyyyhhhhhyyyyoyyyyo+syhddmmmhhs`                       `+syyhhdddddhyssysysyyyhyhhhyyysoyyyso+syhdmmmmhho`                       `osyyhhdddddhysyyyysyyyhhhhhyyysoyyyso+syhdmmmdhh+                      `osyyhhdddddhysyyyysyyyhhhhhyyysoyyyso+syhdmmmdhh+              
 `ohmNMNdhhdNNNMNhyyyhhhhyysyyhhhyhdyshmMMMMMMMMMMNy.                      `shNNMNdhhdNNNMmhyhyhhhhyysyyhhhyhdyshmMMMMMMMMMMNs.                      .shNNMNhhhmNNNMmhyyhhhhhyyshyhhyyhdysdNMMMMMMMMMNmo`                    .shNNMNhhhmNNNMmhyyhhhhhyyshyhhyyhdysdNMMMMMMMMMNmo`            
 `omMMMMMMMMMMMMMMMMdsyddhyyhydddhyysdMMMMMMMMMMMMMMMNo`                   `sNMMMMMMMMMMMMMMMNhshddhyyhydddhyysdMMMMMMMMMMMMMMMmo`                   .sNMMMMMMMMMMMMMMMNhshddhyyhhdddhyysmMMMMMMMMMMMMMMMm+`                 .sNMMMMMMMMMMMMMMMNhshddhyyhhdddhyysmMMMMMMMMMMMMMMMm+`          
 `sNMMMMMMMdhNmMMMMMMMd+hddyssyhhhs+omMMMhhNmMMMMMNMMMMMd.                 .yMMMMMMMMhdNNMMMMMMMh+ddhysshhdhs+oNMMMhhNNMMMMMNMMMMMh`                 -hMMMMMMMMhmmNMMMMMMMyoddhysshhdys+sNMMMydmNMMMMMNMMMMMy`               -hMMMMMMMMhmmNMMMMMMMyoddhysshhdys+sNMMMydmNMMMMMNMMMMMy`         
 /NMMNmMMMMMMMMMMMMmdMMsyhyyo+oooo:sdMMMMMMMMMMMMMdNMMMMMy`                oNMMNNMMMMMMMMMMMMdmMMsyhyyo+oooo:smMMMMMMMMMMMMMdNMMMMMs                 sMMMNNMMMMMMMMMMMMdNMNoyhyy++oooo:smMMMMMMMMMMMMMdMMMMMNo               sMMMNNMMMMMMMMMMMMdNMNoyhyy++oooo:smMMMMMMMMMMMMMdMMMMMNo         
 ``:yMMMMMMMMMMMMMMMMMMMMMmhso+/-::+oohNMMMMMMMMMMMMMMMMMMMMd+             ``:hMMMMMMMMMMMMMMMMMMMMMdhy++/-::o+syMMMMMMMMMMMMMMMMMMMMMd/             ``/dMMMMMMMMMMMMMMMMMMMMMdyy++/-::o+shMMMMMMMMMMMMMMMMMMMMMh-           ``/dMMMMMMMMMMMMMMMMMMMMMdyy++/-::o+shMMMMMMMMMMMMMMMMMMMMMh-        
 `osdhMMMMMMMMMMMMMMMMMMMMMdmd+//:::smmhMMMMMMMMMMMMMMMMMMMMMddso:         .oymdMMMMMMMMMMMMMMMMMMMMMhmh+/::::ymmhMMMMMMMMMMMMMMMMMMMMMddso-         -oymdMMMMMMMMMMMMMMMMMMMMMhmy//::::hmmhMMMMMMMMMMMMMMMMMMMMMhdso.       -oymdMMMMMMMMMMMMMMMMMMMMMhmy//::::hmmhMMMMMMMMMMMMMMMMMMMMMhdso.     
 `+NMMMMMMMMMMMMMMMMMMMNydd/:-:--+ddhmMMMMMMMMMMMMMMMMMMMMyo:`            `.oNMMMMMMMMMMMMMMMMMMMNydh/:-:--+dhyNMMMMMMMMMMMMMMMMMMMMyo-`            `.sMMMMMMMMMMMMMMMMMMMMmydy/:-:--odhhNMMMMMMMMMMMMMMMMMMMNs+.`          `.sMMMMMMMMMMMMMMMMMMMMmydy/:-:--odhhNMMMMMMMMMMMMMMMMMMMNs+.`      
 -mMMMMMMMMMMMMMMMMMNhhdso++++//oydhNMMMMMMMMMMMMMMMMMMh-                  :NMMMMMMMMMMMMMMMMMNhhdso++++//sydhNMMMMMMMMMMMMMMMMMNy.                 `+NMMMMMMMMMMMMMMMMMNyhdoo++++//sydhMMMMMMMMMMMMMMMMMMNs.               `+NMMMMMMMMMMMMMMMMMNyhdoo++++//sydhMMMMMMMMMMMMMMMMMMNs.         
 .sNMMMMMMMMMMMMMMmhmdohmNmmmmmhyhmdmMMMMMMMMMMMMMMMm+`                    -yNMMMMMMMMMMMMMMdhmdodmNmmmmmhyhmdmMMMMMMMMMMMMMMMm/`                    -hMMMMMMMMMMMMMMNdhmhodNmmmmmdhydmdNMMMMMMMMMMMMMMMd:                   -hMMMMMMMMMMMMMMNdhmhodNmmmmmdhydmdNMMMMMMMMMMMMMMMd:           
 .smNMMMMMMMNmdddhs+:+ymmNmmho//shddmNMMMMMMMMMMNs.                        -ymNMMMMMMMNmdddhs/:ohmmNmmy+/+shddmNMMMMMMMMMMNs`                       `-ymNMMMMMMMNmdddhs/:ohmmNmdy+/+shddmNMMMMMMMMMMm+`                     `-ymNMMMMMMMNmdddhs/:ohmmNmdy+/+shddmNMMMMMMMMMMm+`            
 /yddddddddddmmho+//+/::smh+--:///shmmdmmmmmmmddd/                         +ydddddddddmmmho+//+/:/smh/-::://sdmmdmmNmmmmddd:                         oydddddddddmmmho+:/+/:/ymy/-::://ydmmdmmNmmmmddh-                       oydddddddddmmmho+:/+/:/ymy/-::://ydmmdmmNmmmmddh-             
 `hNNNNNNNNNNmdso++//::/++hyo+/--::/+smmmmmNNNmmdys:                       .dNNNNNNNNNNmdso++/:::/oodyo+:--::/+ymmmmNNNNmmdys-                       -dNNNNNNNNNNmhso++/:::/oodso+:--::/+ymmmmNNNNmmdyo-                     -dNNNNNNNNNNmhso++/:::/oodso+:--::/+ymmmmNNNNmmdyo-            
 `.:syyhdmNNNNdhysoo/+/+//oshmmhs+///:+/+oosydmmNNmmdy-                    `.:syyhdmNNNmhhysoo/+/+//oshmmys+////+/+ooyymmmNmmmdy.                   ``-/yyyhdmNNNmhhysoo/+/+/+oshmdyo+//:/+++ooyhmmmNmmmds.                 ``-/yyyhdmNNNmhhysoo/+/+/+oshmdyo+//:/+++ooyhmmmNmmmds.            
 .+shmNmddhdhhhddssyyysoooooydmddmdhssooooyyyyhddyhyyhyo`                  -+shmNmddhhhhdddssyyysoooosydmddmdyssooooyyyyhddyhyyhyo`                  -+yhmNmddhhhhddhssyyysoo+osydmddmdysoooosyyyyhddyhhyhy+                 -+yhmNmddhhhhddhssyyysoo+osydmddmdysoooosyyyyhddyhhyhy+             
 .syddmmmdhyyhyhmmmdhdhyyhdmmhyhhdddmddyyhhddddhyyhysso+-                  -syddmmmdhyyhyhmmmdhdhyhhdmdhhhddddmdhhyhdddddhyyhysso+.                  :shddmmmdhyhhyhmmddhdhyhhdmdhhhddddmdhhyhdddddhyyhysso+`                :shddmmmdhyhhyhmmddhdhyhhdmdhhhddddmdhhyhdddddhyyhysso+`            
 ./yyhhdhdmmmdddmmmNNNNmNNNmdhhydddhhhddmmmNNNNmdhyyyyssho-                ./yyhhdddmmmdddmmmNNNNmmNNmdhhydddhhhddmmmNNNNmdhsyyssyh+.                .+yhhddddmmmdddmmmNNNNmmNNmdhhyddhhhhddmmmNNNNmdhsyyssyh+.              .+yhhddddmmmdddmmmNNNNmmNNmdhhyddhhhhddmmmNNNNmdhsyyssyh+.           
 `:hyyhhdmmdmNMMNNmmNNNNNNmmmNmhdmddddddmNNNNmdddhhyhdmmmdyo:              ./hyyhhdmmdmNMMNNmmNNNNNNmmmNdhdmddddddmNNNNmddhhhyhdmmmdyo-              .+hyyhhdmmmmNMMNNmNNNNNNNmmmNdhdmddddddNNNNNmddhhhyhdmmmdyo.            .+hyyhhdmmmmNMMNNmNNNNNNNmmmNdhdmddddddNNNNNmddhhhyhdmmmdyo.         
 ./syyyhhhdmmmNNNNNMMMMMMMMMMMMNNNNNNNNNNMNNmdddddmNNNmmdhhys`            `.+yyyyhhhdmmmNNNNNMMNMMMMMMMMMNNNNNNNNNMMNNmdhdddmNNNmmdhhyo`            `.+yyyyhhhdmmmNNNNNMMMMMMMMMMMMNNNNNNNNNMMNmddhdddmNNNmmdhhy+`          `.+yyyyhhhdmmmNNNNNMMMMMMMMMMMMNNNNNNNNNMMNmddhdddmNNNmmdhhy+`        
 .oyyyyhyyhdddmNmmNNNNNMMMMMMMMMMMMMMMMMMMMMNNNNNMMMMNNmmdhhhys:.          -syyyyhyyhdddmNmmNNNNNMMMMMMMMMMMMMMMMMMMMMNNNNNMMMMNNmmdhhhyo:.          -syyyyhyyddddmmmmNNNNNMMMMMMMMMMMMMMMMMMMMMNNNNNMMMMNNmmdhhyyo:.        -syyyyhyyddddmmmmNNNNNMMMMMMMMMMMMMMMMMMMMMNNNNNMMMMNNmmdhhyyo:.      
 .syyyydhhyhddddmmmNNNNMMNNNMMMMMMMMMMMMMMMMMNMMMNNNmNNmmmddddhhs/         .syyyhdhhyhddddmmmNNNNMMNNNMMMMMMMMMMMMMMMMMNMMMNNNmNmmmdddddhys:         -yhyyhdhhyhddddmmmNNNNMMNNNMMMMMMMMMMMMMMMMMNMMMNNmmNmmmdddddhys-       -yhyyhdhhyhddddmmmNNNNMMNNNMMMMMMMMMMMMMMMMMNMMMNNmmNmmmdddddhys-     
 /yhhhhyhdddhdmmmmNNNNNNMNNNMNNNNMMNNMNMNNNNNNNNNmmmmmdddddddhhhy+         +yhhhyyddddhddmmmNNmNNNMNNNMNNNNMMNNMNMNNNNNNNNNmmmmddddddddhhhy/        `oydhhyyddddhddmdmNNNNNNMNNNMNNNNMMNNMNMNNNNNNNNNmmmmddddddddhhhy:      `oydhhyyddddhddmdmNNNNNNMNNNMNNNNMMNNMNMNNNNNNNNNmmmmddddddddhhhy:     
 ohhhhhyyhdmmdmdddmmmNNmNNNNNNNNNNNNNNNNNNNNNNNmmmmmdddhhdddhddhhy-        shhhhhyyhdmmdmddmmmNNNmNNNNNNNNNNNNNNNNNNNNNNNmmmmmdddhhddhhdhhhs-       `yhhhhhyyhdmddmddmmmNNNNNNNmNNNNNNNNNNNNNNNNNNNmmmmmdddhhhdhhdhhhs.     `yhhhhhyyhdmddmddmmmNNNNNNNmNNNNNNNNNNNNNNNNNNNmmmmmdddhhhdhhdhhhs.    
 -ymddddhhhddmmmmmddmdmdmmmmmmmmNNNNNNNNNNNNNNmmmmmmmNNmmmmmmmmmmmds`      -hmdhddhhhddmmmmmddmmmmNmmmmmmmNNNNNNNNNNNNNNmmmmmmmNNmmmmmmmmmmmdo       :hmdhddhhhddmmmmmddmmmmNmmmmmmmNNNNNNNNNNNNNNmmmmmmmNNmmmNmmmmmmmd+     :hmdhddhhhddmmmmmddmmmmNmmmmmmmNNNNNNNNNNNNNNmmmmmmmNNmmmNmmmmmmmd+    
 -hddmmmmmddmdmmNmmmmdmdNmmmNNdmmmNmmmNNNNNNNNmmmmmNNmmmmdhhhhhhddddy`     :dddmmmmmddmdmmNmmmmdmdNmmNNmdmmmNmmmNNNNNNNNmmmmNNNmmmmdhhhhhhdddds      /ddmmmmmmddmdmmNmmmddmmNmmNNmdmmmmmmmNNNNNNNNmmmmNNNmmmmhhhdhhhdddho    /ddmmmmmmddmdmmNmmmddmmNmmNNmdmmmmmmmNNNNNNNNmmmmNNNmmmmhhhdhhhdddho    
 `ydddmmddmNNmmmNmNddmmNmdNmddmmNmmmmmdmmmmmmNNNNNNNNNmmmmmddmmddmmmdy`    .hmdmmmddmNNmmmNNNddmmNmdNmddmmNmmmmddmmmmmmNNNNNNNNNmmmmmddmmddmmddy     -hmdmmmddNNmmmmNNNddmNNmdNmddmmNmmmmddmmmmmmNNNNNNNNNmmmmddmmmdmmmdds   -hmdmmmddNNmmmmNNNddmNNmdNmddmmNmmmmddmmmmmmNNNNNNNNNmmmmddmmmdmmmdds    
 -mNmmmmNmmmmNNNNNmNmNmmmmmdmmmmmmNmmNNddhmNNNNNNNNNNMNNmmmmmddmmmdddy     :mNmmmmmmmmmNNNNNmNmmmmmmmdmmmmmmNmmNmdddmNNNNNNNNNNMNNmmmmmddmmdddds     +mNmmmmmmmmmNNNNmmNmmmmmmmdmmmmmmmmmNmdddNNNNNNNNNNNMNNmmmmmddmmdddd+   +mNmmmmmmmmmNNNNmmNmmmmmmmdmmmmmmmmmNmdddNNNNNNNNNNNMNNmmmmmddmmdddd+    
 /yyyyyyyyyyssssyyysyssyyyyysssoosyyssssooyyyyyyyyyyyyyyyyssossssssso+`    +yyyyyyyyyyssssyyysyssyyyyysosoosyyssssosyyyyyyyyyyyyyyyyssossssssso/    `oyyyyyyyyyyssssyyysyssyyyyysosoosyyosssosyyyyyyyyyyyyyyyyssossssssoo/  `oyyyyyyyyyyssssyyysyssyyyyysosoosyyosssosyyyyyyyyyyyyyyyyssossssssoo/    
 
 
 
 Read the help page for information on how to copy the text image.
 
 Please note that these images are not stored on the web server, so you cannot link to these pages expecting anyone to see the image you have converted.
 
 
 
 By Interactivas17
 interactividad.medialab@gmail.com
 https://interactivas17.wordpress.com/
 
 Based on
 Thomas Sanchez Lengeling, 3D Skeleton.
 http://codigogenerativo.com/
 
 */
import java.nio.*;
int  vertLoc;

//transformations
float a = 1.9;
//int zval = -200;
float scaleVal = 260;

//value to scale the depth point when accessing each individual point in the PC.
float scaleDepthPoint = 100.0;

//Distance Threashold
int maxD = 4000; // 4m
int minD = 0;  //  0m

//openGL object and shader
PGL     pgl;
PShader sh;

//VBO buffer location in the GPU
int vertexVboId;
//////////////////////////////////////
import KinectPV2.KJoint;
import KinectPV2.*;

KinectPV2 kinect;


float zVal = -200;
//float rotX = PI;

float rotX = radians(180);  // by default rotate the hole scene 180deg around the x-axis, 
float zoomF = 700;

// the data from openni comes upside down
float rotY = radians(0);

PShape org3D;

PVector p0, p1, p2, dV, vArbi;

float rotateOrg = 0;

public void setup() {

  sh = loadShader("frag.glsl", "vert.glsl");

  PGL pgl = beginPGL();

  IntBuffer intBuffer = IntBuffer.allocate(1);
  pgl.genBuffers(1, intBuffer);

  //memory location of the VBO
  vertexVboId = intBuffer.get(0);

  endPGL();


  //////////////////////////
  p0 = new PVector(0, 0, 0);
  p1 = new PVector(1, 0, 0);
  p2 = new PVector(0, 1, 0);
  vArbi = new PVector(1, 1, 1);

  size(1024, 768, P3D);

  kinect = new KinectPV2(this);

  kinect.enablePointCloud(true);
  kinect.setLowThresholdPC(minD);
  kinect.setHighThresholdPC(maxD);
  kinect.enableDepthImg(true);
  kinect.enableColorImg(true);

  //enable 3d  with (x,y,z) position
  kinect.enableSkeleton3DMap(true);

  kinect.init();

  org3D = loadShape("hepatitis.obj");
  ambientLight(102, 102, 102);
}

public void draw() {
  background(0);

  image(kinect.getColorImage(), 0, 0, 320, 240);
  ////////
  image(kinect.getPointCloudDepthImage(), 320, 0, 320, 240);

  //translate the scene to the center 
  pushMatrix();
  translate(width/2, height/2, zVal);
  //scale(zVal);
 //scale(scaleVal, -1 * scaleVal, scaleVal);
  rotateX(rotX);
  rotateY(rotY);
  scale(zoomF);
  
  
  // Threahold of the point Cloud.
  kinect.setLowThresholdPC(minD);
  kinect.setHighThresholdPC(maxD);
  
  //get the points in 3d space
  FloatBuffer pointCloudBuffer = kinect.getPointCloudDepthPos();

  // obtain XYZ the values of the point cloud
  /*
  stroke(0, 0, 0);
  for(int i = 0; i < kinect.WIDTHDepth * kinect.HEIGHTDepth; i+=3){
      float x = pointCloudBuffer.get(i*3 + 0) * scaleDepthPoint;
      float y = pointCloudBuffer.get(i*3 + 1) * scaleDepthPoint;
      float z = pointCloudBuffer.get(i*3 + 2) * scaleDepthPoint;
      
   
      point(x, y, z);
   }
   */
   //begin openGL calls and bind the shader
  pgl = beginPGL();
  sh.bind();

  //obtain the vertex location in the shaders.
  //useful to know what shader to use when drawing the vertex positions
  vertLoc = pgl.getAttribLocation(sh.glProgram, "vertex");

  pgl.enableVertexAttribArray(vertLoc);

  //data size times 3 for each XYZ coordinate
  int vertData = kinect.WIDTHDepth * kinect.HEIGHTDepth * 3;

  //bind vertex positions to the VBO
  {
    pgl.bindBuffer(PGL.ARRAY_BUFFER, vertexVboId);
    // fill VBO with data
    pgl.bufferData(PGL.ARRAY_BUFFER,   Float.BYTES * vertData, pointCloudBuffer, PGL.DYNAMIC_DRAW);
    // associate currently bound VBO with shader attribute
    pgl.vertexAttribPointer(vertLoc, 3, PGL.FLOAT, false,  Float.BYTES * 3, 0 );
  }
  
   // unbind VBOs
  pgl.bindBuffer(PGL.ARRAY_BUFFER, 0);

  //draw the point buffer as a set of POINTS
  pgl.drawArrays(PGL.POINTS, 0, vertData);

  //disable the vertex positions
  pgl.disableVertexAttribArray(vertLoc);

  //finish drawing
  sh.unbind();
  endPGL();


  ArrayList<KSkeleton> skeletonArray =  kinect.getSkeleton3d();

  //individual JOINTS
  for (int i = 0; i < skeletonArray.size(); i++) {
    KSkeleton skeleton = (KSkeleton) skeletonArray.get(i);
    if (skeleton.isTracked()) {
      KJoint[] joints = skeleton.getJoints();

      float dist;
      PVector p1 = new PVector(joints[KinectPV2.JointType_SpineShoulder].getX(), joints[KinectPV2.JointType_SpineShoulder].getY());
      PVector p2 = new PVector(joints[KinectPV2.JointType_SpineBase].getX(), joints[KinectPV2.JointType_SpineBase].getY());

      int tamaX, tamaY;

      pushMatrix();
      dist = PVector.dist(p1, p2);
      tamaX = int(dist/1.8);
      tamaY = int(dist/1.8);
      translate(joints[KinectPV2.JointType_SpineBase].getX(), joints[KinectPV2.JointType_SpineBase].getY(), joints[KinectPV2.JointType_SpineBase].getZ());
      //sphere(0.05);
      scale(0.005);
      rotateY(rotateOrg);
      shape(org3D);//, joints[KinectPV2.JointType_SpineBase].getX(), joints[KinectPV2.JointType_SpineBase].getY(), joints[jointType].getZ()/10, joints[jointType].getZ()/10);
      //ellipse(0, 0, 0.005, 0.005);

      popMatrix();


      //draw different color for each hand state
      drawHandState(joints[KinectPV2.JointType_HandRight]);
      drawHandState(joints[KinectPV2.JointType_HandLeft]);

      //Draw body
      color col  = skeleton.getIndexColor();
      stroke(col);
      drawBody(joints);
    }
  }
  popMatrix();



  fill(255, 0, 0);
  text(frameRate, 50, 50);
}


void drawBody(KJoint[] joints) {

  drawBone(joints, KinectPV2.JointType_Head, KinectPV2.JointType_Neck);
  drawBone(joints, KinectPV2.JointType_Neck, KinectPV2.JointType_SpineShoulder);
  drawBone(joints, KinectPV2.JointType_SpineShoulder, KinectPV2.JointType_SpineMid);
  drawBone(joints, KinectPV2.JointType_SpineMid, KinectPV2.JointType_SpineBase);
  drawBone(joints, KinectPV2.JointType_SpineShoulder, KinectPV2.JointType_ShoulderRight);
  drawBone(joints, KinectPV2.JointType_SpineShoulder, KinectPV2.JointType_ShoulderLeft);
  drawBone(joints, KinectPV2.JointType_SpineBase, KinectPV2.JointType_HipRight);
  drawBone(joints, KinectPV2.JointType_SpineBase, KinectPV2.JointType_HipLeft);

  // Right Arm
  drawBone(joints, KinectPV2.JointType_ShoulderRight, KinectPV2.JointType_ElbowRight);
  drawBone(joints, KinectPV2.JointType_ElbowRight, KinectPV2.JointType_WristRight);
  drawBone(joints, KinectPV2.JointType_WristRight, KinectPV2.JointType_HandRight);
  drawBone(joints, KinectPV2.JointType_HandRight, KinectPV2.JointType_HandTipRight);
  drawBone(joints, KinectPV2.JointType_WristRight, KinectPV2.JointType_ThumbRight);

  // Left Arm
  drawBone(joints, KinectPV2.JointType_ShoulderLeft, KinectPV2.JointType_ElbowLeft);
  drawBone(joints, KinectPV2.JointType_ElbowLeft, KinectPV2.JointType_WristLeft);
  drawBone(joints, KinectPV2.JointType_WristLeft, KinectPV2.JointType_HandLeft);
  drawBone(joints, KinectPV2.JointType_HandLeft, KinectPV2.JointType_HandTipLeft);
  drawBone(joints, KinectPV2.JointType_WristLeft, KinectPV2.JointType_ThumbLeft);

  // Right Leg
  drawBone(joints, KinectPV2.JointType_HipRight, KinectPV2.JointType_KneeRight);
  drawBone(joints, KinectPV2.JointType_KneeRight, KinectPV2.JointType_AnkleRight);
  drawBone(joints, KinectPV2.JointType_AnkleRight, KinectPV2.JointType_FootRight);

  // Left Leg
  drawBone(joints, KinectPV2.JointType_HipLeft, KinectPV2.JointType_KneeLeft);
  drawBone(joints, KinectPV2.JointType_KneeLeft, KinectPV2.JointType_AnkleLeft);
  drawBone(joints, KinectPV2.JointType_AnkleLeft, KinectPV2.JointType_FootLeft);

  drawJoint(joints, KinectPV2.JointType_HandTipLeft);
  drawJoint(joints, KinectPV2.JointType_HandTipRight);
  drawJoint(joints, KinectPV2.JointType_FootLeft);
  drawJoint(joints, KinectPV2.JointType_FootRight);

  drawJoint(joints, KinectPV2.JointType_ThumbLeft);
  drawJoint(joints, KinectPV2.JointType_ThumbRight);

  drawJoint(joints, KinectPV2.JointType_Head);
}

void drawJoint(KJoint[] joints, int jointType) {
  //int tamaX, tamaY;
  //strokeWeight(0.05f);
  ////strokeWeight(2.0f + joints[jointType].getZ()*8);
  //point(joints[jointType].getX(), joints[jointType].getY(), joints[jointType].getZ());
  //translate(joints[jointType].getX(), joints[jointType].getY(), joints[jointType].getZ());
  //sphere(100);

  // dick vector
  p0.set(joints[KinectPV2.JointType_ShoulderLeft].getX(), joints[KinectPV2.JointType_ShoulderLeft].getY(), joints[KinectPV2.JointType_ShoulderLeft].getZ());
  p1.set(joints[KinectPV2.JointType_ShoulderRight].getX(), joints[KinectPV2.JointType_ShoulderRight].getY(), joints[KinectPV2.JointType_ShoulderRight].getZ());
  p2.set(joints[KinectPV2.JointType_SpineBase].getX(), joints[KinectPV2.JointType_SpineBase].getY(), joints[KinectPV2.JointType_SpineBase].getZ());
  dV = PVector.cross(PVector.sub(p1, p0, null), PVector.sub(p2, p0, null), null);
  dV.normalize();
  float a = PVector.angleBetween(dV, vArbi);
  rotateOrg = a;
  println(degrees(a));

  noStroke();
  beginShape();
  vertex(joints[KinectPV2.JointType_ShoulderLeft].getX(), joints[KinectPV2.JointType_ShoulderLeft].getY(), joints[KinectPV2.JointType_ShoulderLeft].getZ());
  vertex(joints[KinectPV2.JointType_ShoulderRight].getX(), joints[KinectPV2.JointType_ShoulderRight].getY(), joints[KinectPV2.JointType_ShoulderRight].getZ());
  vertex(joints[KinectPV2.JointType_SpineBase].getX(), joints[KinectPV2.JointType_SpineBase].getY(), joints[KinectPV2.JointType_SpineBase].getZ());
  endShape();

  pushMatrix();
  noStroke();
  lights();
  translate(joints[jointType].getX(), joints[jointType].getY(), joints[jointType].getZ());
  sphere(0.05);
  //scale(0.005);
  //shape(org3D);//, joints[KinectPV2.JointType_SpineBase].getX(), joints[KinectPV2.JointType_SpineBase].getY(), joints[jointType].getZ()/10, joints[jointType].getZ()/10);
  //ellipse(0, 0, 0.005, 0.005);
  popMatrix();
}

void drawBone(KJoint[] joints, int jointType1, int jointType2) {
  //strokeWeight(2.0f + joints[jointType1].getZ()*8);
  strokeWeight(0.005f);
  point(joints[jointType2].getX(), joints[jointType2].getY(), joints[jointType2].getZ());
  point(joints[jointType1].getX(), joints[jointType1].getY(), joints[jointType1].getZ());
  //line(joints[jointType1].getX(), joints[jointType1].getY(), joints[jointType1].getZ(), joints[jointType2].getX(), joints[jointType2].getY(), joints[jointType2].getZ());
  /*pushMatrix();
   translate(joints[jointType1].getX(), joints[jointType1].getY(), joints[jointType1].getZ());
   ellipse(0, 0, 25, 25);
   popMatrix();
   line(joints[jointType1].getX(), joints[jointType1].getY(), joints[jointType1].getZ(), joints[jointType2].getX(), joints[jointType2].getY(), joints[jointType2].getZ());
   */
}

void drawHandState(KJoint joint) {
  handState(joint.getState());
  strokeWeight(0.05f);
  point(joint.getX(), joint.getY(), joint.getZ());
}

void handState(int handState) {
  switch(handState) {
  case KinectPV2.HandState_Open:
    stroke(0, 255, 0);
    break;
  case KinectPV2.HandState_Closed:
    stroke(255, 0, 0);
    break;
  case KinectPV2.HandState_Lasso:
    stroke(0, 0, 255);
    break;
  case KinectPV2.HandState_NotTracked:
    stroke(100, 100, 100);
    break;
  }
}

void keyPressed()
{
  switch(keyCode)
  {
  case LEFT:
    rotY += 0.1f;
    break;
  case RIGHT:
    // zoom out
    rotY -= 0.1f;
    break;
  case UP:
    if (keyEvent.isShiftDown())
      zoomF += 0.02f;
    else
      rotX += 0.1f;
    break;
  case DOWN:
    if (keyEvent.isShiftDown())
    {
      zoomF -= 0.02f;
      if (zoomF < 0.01)
        zoomF = 0.01;
    } else
      rotX -= 0.1f;
    break;
  }
}
